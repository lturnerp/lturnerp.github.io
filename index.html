<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proyectos Yadran~REVER</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Saira+Condensed:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#100F2B', 
            'secondary': '#B7BECC', 
            'accent': '#AF9A6B', 
            'text-main': '#100F2B', 
            'text-light': '#6A737D', 
            'border-color': '#AF9A6B', 
            'checkbox-active': '#AF9A6B', 
            'checkbox-border': '#B7BECC',
          },
          fontFamily: {
            'saira': ['"Saira Condensed"', 'sans-serif'],
            'manrope': ['"Manrope"', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <style>
    body {
      font-family: 'Manrope', sans-serif;
      background-color: #B7BECC; 
      -webkit-user-select: none; /* Safari */
      -ms-user-select: none; /* IE 10+ */
      user-select: none; /* Estándar */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // Ya no se necesita DEFAULT_MINDMAP aquí, se cargará desde un archivo

    const generateNodeId = () => {
      return Math.random().toString(36).substr(2, 9);
    };

    const DOC_TYPE_COLORS = {
     "MO": "bg-[#3B82F6]",
     "NP": "bg-[#10B981]",
     "PL": "bg-[#F59E0B]",
     "ORT": "bg-[#8B5CF6]",
     "PANO": "bg-[#EC4899]",
     "DEFAULT": "bg-[#B7BECC]"
    };

    const DOC_TYPE_MAP = {
      "MO": "Modelo 3D",
      "NP": "Nube de Puntos",
      "PL": "Planos",
      "ORT": "Ortofotografía",
      "PANO": "Panoramas"
    };

    const Header = () => {
      return (
        <header className="bg-primary text-white p-3 shadow-md sticky top-0 z-50">
          <div className="container mx-auto flex items-center justify-between">
            <div className="logo-left h-8 md:h-10">
              <svg id="Capa_1" data-name="Capa 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 899.57 180.16" className="h-full"><defs><style>{`.cls-1{fill:#fff;}`}</style></defs><path class="cls-1" d="M439.6,164.69,475.14,15.46h35.12l-45.34,149H414.27l-45.34-149h35.12Z"/><path class="cls-1" d="M305,15.08,288.23,27.9H236.9V77.36h51.19V90.19H236.9v61.3h75.22v13.59h-112v-150Z"/><path class="cls-1" d="M679.33,15.08,662.58,27.9H611.25V77.36h51.2V90.19h-51.2v61.3h75.22v13.59H574.42v-150Z"/><path class="cls-1" d="M80.73,92.33a65.82,65.82,0,0,0,14.83-5.57,45.09,45.09,0,0,0,11.52-8.42,36.37,36.37,0,0,0,7.42-11,32.29,32.29,0,0,0,2.64-13,35.5,35.5,0,0,0-3.43-15.56,34,34,0,0,0-10.17-12.31,49.73,49.73,0,0,0-16.85-8A86.49,86.49,0,0,0,63.2,15.58H11.52v149h.69l24.36-18.88V94.57H54.1l51.8,70H135ZM66.63,84.8a51.51,51.51,0,0,1-15.56,2.25H36.57V24.91h22a34.59,34.59,0,0,1,12.64,2.25,30.43,30.43,0,0,1,10,6.23A27.19,27.19,0,0,1,87.75,43a32.23,32.23,0,0,1,2.31,12.36A28.37,28.37,0,0,1,79,78.45,38.41,38.41,0,0,1,66.63,84.8Z"/><path class="cls-1" d="M137.69,165.92H105.23l-51.8-70H37.91v50.43L12.67,165.92H10.18V14.24h53a88,88,0,0,1,23.85,2.92,51.32,51.32,0,0,1,17.31,8.26,35.44,35.44,0,0,1,10.56,12.79,37,37,0,0,1,3.56,16.14,33.93,33.93,0,0,1-2.75,13.57A38,38,0,0,1,108,79.27,47,47,0,0,1,96.19,88,67.16,67.16,0,0,1,83,93.11Zm-31.11-2.68h25.74L78.45,91.52l2-.49a65.26,65.26,0,0,0,14.53-5.45,44.29,44.29,0,0,0,11.18-8.18,35.23,35.23,0,0,0,7.15-10.55,31.14,31.14,0,0,0,2.53-12.5,34.24,34.24,0,0,0-3.3-15,32.7,32.7,0,0,0-9.77-11.82,48.44,48.44,0,0,0-16.41-7.81A85.46,85.46,0,0,0,63.2,16.92H12.86V162.38L35.23,145V93.23H54.78ZM51.07,88.39H35.23V23.57H58.6a36.12,36.12,0,0,1,13.12,2.34,31.92,31.92,0,0,1,10.44,6.51A28.86,28.86,0,0,1,89,42.49,33.74,33.74,0,0,1,91.4,55.36,29.68,29.68,0,0,1,79.82,79.5,40,40,0,0,1,67,86.08h0A53.16,53.16,0,0,1,51.07,88.39ZM37.91,85.71H51.07a50.44,50.44,0,0,0,15.16-2.19h0a37.06,37.06,0,0,0,11.93-6.13,27,27,0,0,0,10.56-22,31,31,0,0,0-2.21-11.85,26.05,26.05,0,0,0-6.19-9.14,29.13,29.13,0,0,0-9.57-6A33.43,33.43,0,0,0,58.6,26.25H37.91Z"/><path class="cls-1" d="M832.44,92.33a66,66,0,0,0,14.83-5.57,45.09,45.09,0,0,0,11.52-8.42,36.56,36.56,0,0,0,7.42-11,32.46,32.46,0,0,0,2.64-13,35.5,35.5,0,0,0-3.43-15.56,34,34,0,0,0-10.17-12.31,49.73,49.73,0,0,0-16.85-8,86.55,86.55,0,0,0-23.49-2.87H763.23v149h.69l24.36-18.88V94.57h17.53l51.8,70h29.1Zm-14.1-7.53a51.51,51.51,0,0,1-15.56,2.25h-14.5V24.91h22A34.63,34.63,0,0,1,823,27.16a30.43,30.43,0,0,1,10,6.23A27.19,27.19,0,0,1,839.46,43a32.23,32.23,0,0,1,2.31,12.36A28.37,28.37,0,0,1,830.7,78.45,38.41,38.41,0,0,1,818.34,84.8Z"/><path class="cls-1" d="M889.39,165.92H856.93l-51.79-70H789.62v50.43l-25.24,19.58h-2.49V14.24h53a88,88,0,0,1,23.85,2.92,51.42,51.42,0,0,1,17.31,8.26,35.44,35.44,0,0,1,10.56,12.79,37,37,0,0,1,3.56,16.14,33.77,33.77,0,0,1-2.76,13.57,37.77,37.77,0,0,1-7.68,11.35A47,47,0,0,1,847.9,88a67.16,67.16,0,0,1-13.19,5.16Zm-31.1-2.68H884L830.16,91.52l2-.49a65.26,65.26,0,0,0,14.53-5.45,44.29,44.29,0,0,0,11.18-8.18A35.23,35.23,0,0,0,865,66.85a31.14,31.14,0,0,0,2.53-12.5,34.24,34.24,0,0,0-3.3-15,32.7,32.7,0,0,0-9.77-11.82A48.44,48.44,0,0,0,838,19.74a85.46,85.46,0,0,0-23.12-2.82H764.57V162.38L786.94,145V93.23h19.55ZM802.78,88.39H786.94V23.57h23.37a36.12,36.12,0,0,1,13.12,2.34,31.92,31.92,0,0,1,10.44,6.51,28.86,28.86,0,0,1,6.83,10.07,33.74,33.74,0,0,1,2.41,12.87A29.76,29.76,0,0,1,831.53,79.5a40.08,40.08,0,0,1-12.79,6.58h0A53.16,53.16,0,0,1,802.78,88.39Zm-13.16-2.68h13.16a50.44,50.44,0,0,0,15.16-2.19h0a37.06,37.06,0,0,0,11.93-6.13,27,27,0,0,0,10.56-22,31,31,0,0,0-2.21-11.85A26.05,26.05,0,0,0,832,34.37a29.13,29.13,0,0,0-9.57-6,33.43,33.43,0,0,0-12.15-2.16H789.62Z"/></svg>
            </div>
            <div className="logo-right h-8 md:h-10">
              <svg id="Capa_2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 199.32 43.32" className="h-full"><defs><style>{`.cls-1{fill:#fff;stroke-width:0px;}`}</style></defs><g id="Dño"><path class="cls-1" d="m31.1,5.7c-2.92-1.82-6.24-2.9-9.58-3.1C19.82,1.08,17.63.15,15.34,0h-.12s-.21,3.29-.21,3.29c-4.87,1.34-9.04,4.35-11.76,8.49C.31,16.26-.68,21.68.46,27.05l.27,1.26,1.28.13c.12.01.25.02.37.03,4.39.34,7.7-1.38,10.98-3.33l1.59-.95-3.25-4.93c1.99-1.33,4.45-1.94,6.73-1.66,1.62.2,3.88.93,5.46,3.29.87,1.3,1.83,2.41,2.87,3.32.79.74,1.74,1.37,2.81,1.89l.12.04h0c3.06,1.42,6.51,1.31,9.98-.32l.94-.44.07-1.04c.14-1.99-.02-3.99-.47-5.95-1.21-5.27-4.44-9.78-9.12-12.7Zm.39,17.38c-.92-.38-1.81-.98-2.66-1.77-1.25-1.31-2.67-3.68-2.37-7.48v-.13s-.12,0-.12,0c-1.47-.06-2.51.53-3.18,1.8-1.3-.74-2.75-1.21-4.3-1.4-3.81-.46-7.82.84-10.72,3.48l-1.12,1.02,2.92,4.43c-1.82,1-3.83,1.9-6.26,1.95-.53-3.98.36-7.97,2.52-11.25,2.38-3.62,6.07-6.17,10.41-7.19,1.63-.38,3.3-.51,4.97-.38,2.66.21,5.3,1.09,7.64,2.55,3.87,2.41,6.54,6.13,7.54,10.48.29,1.27.43,2.56.43,3.85-2.05.75-3.96.76-5.7.04Z"/><path class="cls-1" d="m30.99,31.85c-3.4,0-5.94-1.03-8.4-2.02-2.19-.88-4.25-1.71-6.69-1.71-1.72,0-3.48.42-5.38,1.27-2.15.97-4.49,2.5-7.13,4.68h-.01s0,.03,0,.03c3.78,5.77,10.15,9.22,17.04,9.22,4.25,0,8.31-1.29,11.76-3.74,3.37-2.39,5.91-5.7,7.34-9.57l.02-.04-.04.02c-3.11,1.26-5.9,1.87-8.51,1.87Zm-10.57,7.93c-2.28,0-4.49-.45-6.58-1.34-2.06-.87-3.9-2.13-5.47-3.74,3.93-2.74,6.17-3.05,7.52-3.05,1.76,0,3.35.64,5.37,1.46,2.64,1.07,5.64,2.28,9.72,2.28.26,0,.52,0,.78-.01-3.12,2.85-7.15,4.41-11.34,4.41Z"/><path class="cls-1" d="m195.53,11.16v17.36l-13.37-17.84h0s-3.78,0-3.78,0v24.57h3.3c.27,0,.48-.22.48-.48v-17.35l13.36,17.84h0s0,0,0,0h3.78V10.67h-3.3c-.27,0-.48.22-.48.48Z"/><path class="cls-1" d="m158.66,10.67l-8.17,21.41c-.92.36-1.97.58-3.22.58-3.75,0-5.24-1.87-7.13-4.23-.76-.95-1.58-1.98-2.62-2.92,1.04-.15,1.98-.4,2.8-.78,1.35-.61,2.37-1.49,3.07-2.64.7-1.15,1.04-2.52,1.04-4.14s-.31-2.87-.92-3.95c-.61-1.08-1.58-1.9-2.89-2.48-1.31-.57-2.99-.86-5.03-.86h-9.99v24.56h4.01v-9.34c4.23.17,5.91,2.26,7.84,4.68,2.07,2.59,4.41,5.52,9.81,5.52,5.1,0,7.83-2.64,10.23-4.97,2.55-2.47,4.43-4.27,8.81-3.3l.11.28,2.6,6.82c.07.19.25.31.45.31h4.01l-9.41-24.56h-5.4Zm-23.47,11.5h-5.08c-.27,0-.48-.22-.48-.48v-7.1c0-.27.22-.48.48-.48h5.21c1.28,0,2.31.14,3.07.43.76.29,1.3.72,1.62,1.29.31.57.47,1.31.47,2.21,0,1.42-.44,2.46-1.33,3.13-.89.67-2.2,1-3.95,1Zm21.13,5.33l.36-.95,4.06-10.92c.16-.42.75-.42.91,0l3.25,8.51c-4-.28-6.49,1.45-8.58,3.36Z"/><path class="cls-1" d="m115.02,12.08c-1.83-.94-4.15-1.41-6.96-1.41h-8.95v24.56h9.03c2.57,0,4.76-.5,6.59-1.52,1.83-1.01,3.23-2.44,4.22-4.3.98-1.86,1.47-4.07,1.47-6.63s-.44-4.79-1.33-6.59c-.89-1.8-2.24-3.17-4.07-4.11Zm.51,15.6c-.59,1.35-1.5,2.39-2.74,3.11-1.24.72-2.9,1.08-4.97,1.08h-4.2c-.27,0-.48-.22-.48-.48V14.51c0-.27.22-.48.48-.48h3.96c2.07,0,3.77.31,5.08.94,1.31.63,2.27,1.58,2.87,2.84.6,1.27.9,2.93.9,4.97,0,1.91-.29,3.54-.88,4.89Z"/><path class="cls-1" d="m67.4,10.92l-6.72,11.98c-.19.33-.66.33-.84,0l-6.72-11.98c-.09-.15-.25-.25-.42-.25h-3.83l9.37,16.58v7.98h4.04v-7.98h0l9.37-16.58h-3.83c-.18,0-.34.09-.42.25Z"/><path class="cls-1" d="m80.02,10.67l-6.47,16.96-1.26,3.31-1.64,4.29h3.84c.2,0,.38-.13.45-.32l.13-.34c2.52-6.29,9.81-7.32,11.68-6.84.4.1.74.23,1.04.38l2.6,6.82c.07.19.25.31.45.31h4.01l-9.41-24.56h-5.4Zm-1.25,15.47c-.24.16-.49.29-.73.43l4.06-10.92c.16-.42.75-.42.91,0l3.23,8.45c-1.94-.19-4.5.16-7.47,2.04Z"/></g></svg>
            </div>
          </div>
        </header>
      );
    };

    const CheckboxIcon = ({ checked, onChange }) => {
      return (
        <button
          type="button"
          onClick={onChange}
          className="inline-flex items-center justify-center focus:outline-none mr-1 flex-shrink-0"
          aria-label={checked ? "Checked" : "Unchecked"}
        >
          <div
            className={`w-4 h-4 border-2 rounded ${checked ? 'bg-checkbox-active border-checkbox-active' : 'border-checkbox-border'}`}
          >
            {checked && (
              <div className="w-full h-full flex items-center justify-center">
                <div className="w-2 h-2 bg-white rounded-sm"></div>
              </div>
            )}
          </div>
        </button>
      );
    };

    const ExpandCollapseIcon = ({ expanded, onClick, hasChildren }) => {
      if (!hasChildren) {
        return <span className="w-5 h-5 mr-1 flex-shrink-0"></span>;
      }
      return (
        <button
          type="button"
          onClick={onClick}
          className="w-5 h-5 mr-1 focus:outline-none text-text-light hover:text-text-main transition-colors flex-shrink-0"
          aria-label={expanded ? 'Collapse' : 'Expand'}
        >
          <svg
            className={`w-4 h-4 transform transition-transform duration-200 ${expanded ? 'rotate-90' : ''}`}
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fillRule="evenodd"
              d="M7.293 4.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L10.586 9 7.293 5.707a1 1 0 010-1.414z"
              clipRule="evenodd"
            />
          </svg>
        </button>
      );
    };

    const ColorIndicator = ({ colorClass }) => {
      const finalColorClass = colorClass || DOC_TYPE_COLORS.DEFAULT;
      return (
        <span className={`inline-block w-3 h-3 ${finalColorClass} rounded-full mr-2 flex-shrink-0`}></span>
      );
    };

    const MindMapNode = ({ node, level, onToggleChecked, onToggleExpanded, inheritedColor }) => {
      const paddingLeft = `${level * 20}px`; 
      const hasChildren = node.children && node.children.length > 0;

      const currentNodeColorClass = node.docTypeCode ? (DOC_TYPE_COLORS[node.docTypeCode] || DOC_TYPE_COLORS.DEFAULT) : inheritedColor;

      const handleCheckboxToggle = (e) => {
        e.stopPropagation();
        onToggleChecked(node.id);
      };

      const handleNodeClick = (e) => {
        if (e.target.tagName === 'A' || e.target.closest('a') || e.target.closest('button[aria-label*="Checked"]')) {
          return;
        }
        if (hasChildren) {
            e.stopPropagation(); 
            onToggleExpanded(node.id);
        }
      };
      
      const handleIconClickToExpand = (e) => {
        e.stopPropagation();
        if (hasChildren) {
            onToggleExpanded(node.id);
        }
      }

      const renderContent = () => {
        let tooltip = node.originalContent; 
        
        if (node.isParsedFolder) {
            tooltip = `Original: ${node.parsedNodeOriginalText}\n`;
            if (node.docTypeFull) tooltip += `Tipo Doc.: ${node.docTypeFull}\n`;
            if (node.projectName) tooltip += `Proyecto: ${node.projectName}\n`;
            tooltip += `Estatus: ${node.status || 'N/A'}, Revisión: ${node.revision || 'N/A'}`;
        } else if (node.linkUrl && node.originalContent !== node.displayContent) {
            tooltip = `Enlace: ${node.displayContent}\nURL: ${node.linkUrl}\nOriginal Markdown: ${node.originalContent}`;
        } else if (node.originalContent !== node.displayContent) { 
            tooltip = `Original Markdown: ${node.originalContent}`;
        }

        const mainTextClasses = `
          truncate font-manrope 
          ${node.checked ? 'font-semibold text-accent' : 'text-text-main'}
        `;
        
        const containerClasses = `
            ml-1 flex-grow min-w-0 
            ${hasChildren ? 'cursor-pointer' : 'cursor-default'} 
        `;

        const textToShowAsMain = node.displayContent; 
        const textToShowAsOriginal = node.isParsedFolder ? node.parsedNodeOriginalText : null;

        return (
          <div 
            className={`flex items-baseline justify-between w-full ${containerClasses}`} 
            title={tooltip}
          >
            <div className="truncate mr-2"> 
              {node.linkUrl ? (
                <a
                  href={node.linkUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className={`text-blue-600 hover:text-blue-800 hover:underline ${mainTextClasses} ${node.checked ? 'text-accent' : ''}`}
                  onClick={(e) => e.stopPropagation()} 
                >
                  {textToShowAsMain}
                </a>
              ) : (
                <span className={mainTextClasses}>
                  {textToShowAsMain}
                </span>
              )}
            </div>

            {textToShowAsOriginal && (
              <span
                className="hidden sm:inline-block text-xs text-text-light font-manrope font-normal whitespace-nowrap truncate flex-shrink-0" 
                title={textToShowAsOriginal}
              >
                 {textToShowAsOriginal}
              </span>
            )}
          </div>
        );
      };
      
      let nodeBaseClasses = "flex items-center py-1.5 px-2 hover:bg-secondary rounded transition-colors duration-200 text-text-main";
      if (node.isHeaderLine) {
        nodeBaseClasses += " font-saira";
        if (level === 0) nodeBaseClasses += " font-bold text-xl mt-2 mb-1"; 
        else if (level === 1) nodeBaseClasses += " font-semibold text-lg mt-1";
      } else {
        nodeBaseClasses += " font-manrope";
        if (level === 0) nodeBaseClasses += " font-semibold text-lg"; 
        else if (level === 1) nodeBaseClasses += " font-medium text-base";
        else nodeBaseClasses += " text-sm";
      }

      return (
        <>
          <div
            className={nodeBaseClasses}
            style={{ paddingLeft: level > 0 ? paddingLeft : '0px' }} 
            onClick={handleNodeClick} 
          >
            {level >= 1 ? (
              <ColorIndicator colorClass={currentNodeColorClass} />
            ) : (
              <span className="w-3 h-3 mr-2 flex-shrink-0"></span>
            )}

            <ExpandCollapseIcon
              expanded={node.expanded}
              onClick={handleIconClickToExpand} 
              hasChildren={hasChildren}
            />  

            {node.isCheckbox && (
              <CheckboxIcon
                checked={node.checked || false}
                onChange={handleCheckboxToggle}
              />
            )}
            {renderContent()}
          </div>

          {node.expanded && node.children && (
            <div className="transition-all duration-200 ease-in-out">
              {node.children.map((childNode) => (
                <MindMapNode
                  key={childNode.id}
                  node={childNode}
                  level={level + 1}
                  onToggleChecked={onToggleChecked}
                  onToggleExpanded={onToggleExpanded}
                  inheritedColor={currentNodeColorClass} 
                />
              ))}
            </div>
          )}
        </>
      );
    };

    const MindMap = ({ data, onNodesChange }) => {
      const [rootNode, setRootNode] = React.useState(data);

      React.useEffect(() => {
        setRootNode(data);
      }, [data]);

      const updateNodeRecursively = (currentNode, nodeId, updateFn) => {
        if (currentNode.id === nodeId) {
          return updateFn(currentNode);
        }
        if (currentNode.children && currentNode.children.length > 0) {
          const newChildren = currentNode.children.map(child => 
            updateNodeRecursively(child, nodeId, updateFn)
          );
          if (newChildren.some((child, index) => child !== currentNode.children[index])) {
            return { ...currentNode, children: newChildren };
          }
        }
        return currentNode;
      };
      
      const handleToggleChecked = (nodeId) => {
        const newRootNode = updateNodeRecursively(rootNode, nodeId, node => ({
          ...node,
          checked: !node.checked
        }));
        setRootNode(newRootNode);
        onNodesChange(newRootNode);
      };

      const handleToggleExpanded = (nodeId) => {
        const newRootNode = updateNodeRecursively(rootNode, nodeId, node => ({
          ...node,
          expanded: !node.expanded
        }));
        setRootNode(newRootNode);
        onNodesChange(newRootNode);
      };
      
      // Si rootNode es null (aún cargando), no renderizar nada o un loader.
      // El componente App ya maneja un estado de carga, por lo que aquí podemos asumir que `data` existe.
      if (!rootNode || !rootNode.id) {
          return <div className="p-4 bg-white rounded-lg shadow-lg text-center text-text-main font-manrope">Cargando datos del mapa...</div>;
      }

      return (
        <div className="p-4 bg-white rounded-lg shadow-lg">
          <div 
            className="flex items-center text-2xl font-saira font-bold mb-4 cursor-pointer text-primary"
            title={rootNode.originalContent || rootNode.displayContent}
          >
            <span className="ml-1">{rootNode.displayContent}</span>
          </div>

          {rootNode.expanded && rootNode.children && rootNode.children.length > 0 && (
            <div className="border-l-2 border-border-color"> 
              {rootNode.children.map(node => (
                <MindMapNode
                  key={node.id}
                  node={node}
                  level={0} 
                  onToggleChecked={handleToggleChecked}
                  onToggleExpanded={handleToggleExpanded}
                  inheritedColor={node.docTypeCode ? (DOC_TYPE_COLORS[node.docTypeCode] || DOC_TYPE_COLORS.DEFAULT) : DOC_TYPE_COLORS.DEFAULT}
                />
              ))}
            </div>
          )}
        </div>
      );
    };

    function parseNodeNameAndDetails(textToParse) {
      let docTypeCode = null;
      let docTypeFull = null;
      let status = null;
      let revision = null;
      let projectName = "";
      let isParsedFolder = false;

      const subfolderRegex = /^([A-Z0-9]+)-([A-Z]{2,4})-([0-9]+)-(.+)-([TC])-(A|B|0)$/i;
      const mainFolderRegex = /^([A-Z0-9]+)-(.+)-([TC])-(A|B|0)$/i;

      let match = textToParse.match(subfolderRegex);
      if (match) {
        isParsedFolder = true;
        docTypeCode = match[2].toUpperCase();
        projectName = match[4].trim();
        status = match[5].toUpperCase();
        revision = match[6].toUpperCase();
        docTypeFull = DOC_TYPE_MAP[docTypeCode] || docTypeCode; 
      } else {
        match = textToParse.match(mainFolderRegex);
        if (match) {
          isParsedFolder = true;
          projectName = match[2].trim();
          status = match[3].toUpperCase();
          revision = match[4].toUpperCase();
        }
      }
      return { docTypeCode, docTypeFull, status, revision, projectName, isParsedFolder, parsedNodeOriginalText: textToParse };
    }

    function parseMarkdownToMindMap(markdown) {
      const lines = markdown.split('\n').filter(line => line.trim());
      if (lines.length === 0) {
        return { 
            id: generateNodeId(), 
            originalContent: "Mindmap Vacío", 
            displayContent: "Mindmap Vacío", 
            parsedNodeOriginalText: "Mindmap Vacío",
            children: [], 
            expanded: true, 
            isHeaderLine: true 
        };
      }

      const pseudoRoot = { id: 'pseudo-root', children: [], level: -1, isHeaderContext: false, isParsedFolder: false, docTypeCode: null, originalContent: "PSEUDO_ROOT" };
      const stack = [pseudoRoot];
      const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/;

      let isFirstNode = true; 

      lines.forEach(line => {
        const trimmedLine = line.trim();
        const indentLevel = line.search(/\S|$/);
        
        let textAfterPrefixes = trimmedLine.replace(/^[#\-\s]*/, '');
        const isCheckbox = textAfterPrefixes.startsWith('[ ]');
        if (isCheckbox) {
          textAfterPrefixes = textAfterPrefixes.substring(3).trim();
        }
        
        const originalContentForNode = textAfterPrefixes; 
        let textForDetailsParsing = originalContentForNode;
        let linkUrl = null;
        let linkTextIfAny = null;

        const linkMatch = originalContentForNode.match(linkRegex);
        if (linkMatch) {
          linkTextIfAny = linkMatch[1];
          linkUrl = linkMatch[2];
          textForDetailsParsing = linkTextIfAny;
        }

        const details = parseNodeNameAndDetails(textForDetailsParsing);
        let finalDisplayContent;
        
        const isHeaderLine = trimmedLine.startsWith('#');
        let nodeLevel;
        if (isHeaderLine) {
            nodeLevel = (trimmedLine.match(/^#+/) || [''])[0].length - 2; 
        } else {
            nodeLevel = Math.floor(indentLevel / 2); 
        }

        while (stack.length > 1 && stack[stack.length - 1].level >= nodeLevel &&
               !(isHeaderLine && stack[stack.length-1].level === nodeLevel -1 && stack[stack.length-1].isHeaderContext && nodeLevel > stack[stack.length-1].level) &&
               !(!isHeaderLine && stack[stack.length-1].isHeaderContext && nodeLevel > stack[stack.length-1].level)
        ) {
            if (isHeaderLine) {
                if (stack[stack.length-1].level >= nodeLevel) stack.pop(); else break;
            } else { 
                if (stack[stack.length - 1].level >= nodeLevel && !stack[stack.length - 1].isHeaderContext) stack.pop();
                else if (stack[stack.length - 1].isHeaderContext && nodeLevel <= stack[stack.length - 1].level) stack.pop(); 
                else break;
            }
        }
        
        const parentNodeFromStack = stack[stack.length - 1];

        if (details.isParsedFolder) {
            if (!details.docTypeCode) { 
                finalDisplayContent = details.projectName;
            } else { 
                let parentIsEffectivelyProjectRootOrHeader = 
                    (parentNodeFromStack.isParsedFolder && !parentNodeFromStack.docTypeCode && parentNodeFromStack.id !== 'pseudo-root') ||
                    parentNodeFromStack.isHeaderContext;

                if (parentIsEffectivelyProjectRootOrHeader) {
                    finalDisplayContent = details.docTypeFull || details.projectName; 
                } else {
                    finalDisplayContent = details.projectName;
                }
            }
        } else if (linkUrl) { 
            finalDisplayContent = linkTextIfAny || details.parsedNodeOriginalText;
        } else { 
            finalDisplayContent = details.parsedNodeOriginalText;
        }
        
        const shouldBeExpanded = isFirstNode; 
        if (isFirstNode) isFirstNode = false;

        const newNode = {
            id: generateNodeId(),
            originalContent: originalContentForNode, 
            displayContent: finalDisplayContent,      
            ...details, 
            linkUrl,
            children: [],
            expanded: shouldBeExpanded, 
            isCheckbox,
            isHeaderLine,
        };

        stack[stack.length - 1].children.push(newNode);
        stack.push({ 
            ...newNode, 
            level: nodeLevel, 
            isHeaderContext: isHeaderLine 
        }); 
      });
      
      const actualRootNode = pseudoRoot.children[0];
      if (actualRootNode) {
        return actualRootNode;
      }
      
      return { 
        id: generateNodeId(), 
        originalContent: "Error: No se pudieron parsear los datos", 
        displayContent: "Error de Parseo", 
        parsedNodeOriginalText: "Error de Parseo",
        children: [], 
        expanded: true, 
        isHeaderLine: true 
      };
    }

    const Legend = () => {
    const documentTypes = Object.entries(DOC_TYPE_MAP).map(([code, name]) => ({
        code,
        name,
        colorClass: DOC_TYPE_COLORS[code] || DOC_TYPE_COLORS.DEFAULT
    }));

    const statusTypes = [
        { code: "C", description: "Compartido" },
        { code: "T", description: "Trabajo en progreso" }
    ];

    const revisionTypes = [
        { code: "A", description: "Revisión Alfabética (A, B, C...)" },
        { code: "0", description: "Revisión Numérica (0, 1, 2...)" }
    ];

    const folderPatterns = [
        {
            description: "CARPETA PRINCIPAL DEL PROYECTO",
            code: "PR#-NOMBREPROYECTO-ESTADO-REV"
        },
        {
            description: "SUBCARPETA DE TIPO DE DOCUMENTO",
            code: "PR#-TIPO-#-NOMBRE-ESTADO-REV"
        }
    ];

    return (
        <div className="p-4 bg-white rounded-lg shadow-lg">
            <h3 className="text-xl font-saira font-bold mb-1 text-primary text-center">
                Codificación de Carpetas
            </h3>
            <p className="text-sm font-manrope text-text-main mb-4 text-center md:text-left"> 
                Los nombres de las carpetas siguen un patrón para identificar proyectos y tipos de documentos:
            </p>
            <div className="mb-6">
                <div className="flex justify-center">
                    <div className="inline-block text-left space-y-2"> 
                        {folderPatterns.map((pattern, index) => (
                            <div key={index}>
                                <p className="text-sm font-manrope text-text-main font-semibold mb-2 text-center">{pattern.description}</p>
                                <code className="block bg-secondary px-2 py-1 rounded text-sm text-text-main mt-0.5">
                                    {pattern.code}
                                </code>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
            <div className="space-y-5">
                <div>
                    <p className="text-sm font-manrope text-text-main font-semibold mb-2 text-center">
                        TIPO
                    </p>
                    <div className="flex justify-center">
                        <ul className="space-y-1.5 inline-block text-left">
                            {documentTypes.map(docType => (
                                <li key={docType.code} className="flex items-center text-sm font-manrope">
                                    <span className={`inline-block w-3 h-3 ${docType.colorClass} rounded-full mr-2 flex-shrink-0`}></span>
                                    <span className="text-text-main">
                                        <strong className="font-medium">{docType.code}:</strong> {docType.name}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
                <div>
                    <p className="text-sm font-manrope text-text-main font-semibold mb-2 text-center">
                        ESTADO
                    </p>
                    <div className="flex justify-center">
                        <ul className="space-y-1 inline-block text-left">
                            {statusTypes.map(status => (
                                <li key={status.code} className="text-sm font-manrope">
                                    <span className="text-text-main pl-[calc(0.75rem+0.5rem)]">
                                        <strong className="font-medium">{status.code}:</strong> {status.description}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
                <div>
                    <p className="text-sm font-manrope text-text-main font-semibold mb-2 text-center">
                        REV
                    </p>
                    <div className="flex justify-center">
                        <ul className="space-y-1 inline-block text-left">
                            {revisionTypes.map(rev => (
                                <li key={rev.code} className="text-sm font-manrope">
                                    <span className="text-text-main pl-[calc(0.75rem+0.5rem)]">
                                        <strong className="font-medium">{rev.code}:</strong> {rev.description}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
};

    function App() {
      const [mindmapData, setMindmapData] = React.useState(null);
      const [loadingError, setLoadingError] = React.useState(null);

      React.useEffect(() => {
        const loadMindmapFromFile = async () => {
          try {
            // Asegúrate de que 'data.txt' esté en la misma carpeta que tu HTML,
            // o proporciona la ruta correcta si está en otro lugar accesible por el servidor.
            const response = await fetch('./data.txt'); 
            if (!response.ok) {
              throw new Error(`Error al cargar el archivo: ${response.statusText} (status: ${response.status})`);
            }
            const markdownText = await response.text();
            const initialParsedData = parseMarkdownToMindMap(markdownText);
            
            if (initialParsedData && initialParsedData.id) {
                setMindmapData(initialParsedData);
                setLoadingError(null);
            } else {
                // Esto podría ocurrir si parseMarkdownToMindMap devuelve algo inesperado
                // aunque ya tiene un fallback para "Error de Parseo".
                console.error("Fallo al parsear los datos del archivo, incluso después del fallback de parseo.");
                setMindmapData(parseMarkdownToMindMap("")); // Mostrar un mapa vacío como último recurso
                setLoadingError("Error al procesar los datos");
            }
          } catch (error) {
            console.error("Error cargando data.txt:", error);
            setLoadingError(`No se pudo cargar la información: ${error.message}.`);
            // Si falla la carga, parsear una cadena vacía para mostrar un mapa vacío
            setMindmapData(parseMarkdownToMindMap("")); 
          }
        };

        loadMindmapFromFile();
      }, []); // El array vacío asegura que esto se ejecute solo una vez, al montar el componente


      const handleNodesChange = (newRootNodeData) => {
        setMindmapData(newRootNodeData);
        // Ya no se guarda en localStorage
      };

      return (
        <div className="min-h-screen flex flex-col"> 
          <Header />
          <main className="flex-grow p-2 sm:p-4">
            <div className="max-w-7xl mx-auto flex flex-col lg:flex-row gap-4">
              
              <div className="flex-grow lg:w-2/3 space-y-4"> 
                {loadingError && (
                  <div className="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-lg text-center font-manrope">
                    {loadingError}
                  </div>
                )}
                {mindmapData ? (
                  <MindMap
                    data={mindmapData}
                    onNodesChange={handleNodesChange}
                  />
                ) : (
                  !loadingError && <div className="p-4 bg-white rounded-lg shadow-lg text-center text-text-main font-manrope">Cargando lista...</div>
                )}
              </div>

              <div className="lg:w-1/3 lg:max-w-md flex-shrink-0">
                <Legend />
              </div>

            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );
  </script>
</body>
</html>