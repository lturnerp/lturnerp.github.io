<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Ortofoto</title>

    <script src="https://unpkg.com/geotiff@2.0.7/dist-browser/geotiff.js"></script>

    <!-- Importación de fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&family=Saira+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-title: 'Saira Condensed', sans-serif;
            --font-body: 'Manrope', sans-serif;
            --color-dark-blue: #100F2B;
            --color-gold: #AF9A6B;
            --color-black: #000000;
            --color-white: #FFFFFF;
        }
        body { font-family: var(--font-body); margin: 0; height: 100vh; background-color: #f0f2f5; overflow: hidden; }
        .main-container { display: flex; width: 100%; height: 100%; }
        
        #sidebar { width: 350px; background-color: var(--color-white); padding: 25px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 5; display: flex; flex-direction: column; }
        #sidebar-header h1 { font-family: var(--font-title); color: var(--color-dark-blue); font-size: 2.5em; margin: 0 0 40px 0; text-align: center; }
        .control-group { margin-bottom: 25px; }
        .control-group label { font-family: var(--font-title); color: var(--color-dark-blue); font-size: 1.5em; margin-bottom: 10px; display: block; }
        
        .control-group button { width: 100%; padding: 12px; font-family: var(--font-body); font-size: 1em; font-weight: bold; border-radius: 5px; border: 2px solid var(--color-gold); background-color: var(--color-gold); color: var(--color-white); cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .control-group button:hover:not(:disabled) { background-color: var(--color-dark-blue); border-color: var(--color-dark-blue); }
        .control-group button:disabled { background-color: #e0e0e0; border-color: #e0e0e0; cursor: not-allowed; }
        #measure-toggle.active { background-color: var(--color-dark-blue); color: var(--color-white); border-color: var(--color-dark-blue); }
        
        .display-box { padding: 15px; border-radius: 5px; color: var(--color-dark-blue); }
        #status { background-color: #f1f3f5; border-left: 5px solid var(--color-gold); }
        #status p, #result-display p { margin: 5px 0; }
        #result-display { background-color: #f1f3f5; border-left: 5px solid var(--color-dark-blue); }
        #result-display b { font-size: 1.2em; }

        #logo-container { margin-top: auto; padding-top: 20px; text-align: center; }
        #logo-container img { max-width: 150px; height: auto; }

        #map-container { flex-grow: 1; position: relative; overflow: hidden; background-color: var(--color-black); }
        #map-canvas { position: absolute; top: 0; left: 0; cursor: grab; }
        #map-canvas.panning { cursor: grabbing; }
        #map-canvas.measuring-mode { cursor: crosshair; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="sidebar">
            <div id="sidebar-header">
                <h1>Visor de Ortofoto</h1>
            </div>
            <div id="load-control-group" class="control-group">
                <button id="load-image-btn">Iniciar</button>
            </div>
            <div id="measure-control-group" class="control-group" style="display: none;">
                <button id="measure-toggle">Medir</button>
            </div>
            <div class="control-group">
                <label>Estado</label>
                <div id="status" class="display-box">
                    <p>Presiona 'Iniciar' para comenzar.</p>
                </div>
            </div>
            <!-- CAMBIO: Este grupo ahora está oculto por defecto -->
            <div id="result-control-group" class="control-group" style="display: none;">
                <label>Resultado Medición</label>
                <div id="result-display" class="display-box">
                    <p>--- metros</p>
                </div>
            </div>
            <div id="logo-container">
                <img src="./rever-azul-grande.svg" alt="Logo de la Marca">
            </div>
        </div>
        <main id="map-container"><canvas id="map-canvas"></canvas></main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('map-container');
            const canvas = document.getElementById('map-canvas');
            const ctx = canvas.getContext('2d');
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result-display');
            const loadBtn = document.getElementById('load-image-btn');
            const measureBtn = document.getElementById('measure-toggle');
            const loadGroup = document.getElementById('load-control-group');
            const measureGroup = document.getElementById('measure-control-group');
            const resultGroup = document.getElementById('result-control-group'); // Nuevo selector
            
            const imageUrl = './30cm.tif';
            
            let offscreenCanvas = document.createElement('canvas');
            let offscreenCtx = offscreenCanvas.getContext('2d');
            
            let realScale = null, startPoint = null, endPoint = null;
            let measuring = false, isMeasureModeActive = false;
            let transform = { scale: 1, offsetX: 0, offsetY: 0 };
            let isPanning = false, lastPanPosition = { x: 0, y: 0 };
            
            measureBtn.disabled = true;
            loadBtn.addEventListener('click', () => {loadBtn.disabled = true; loadBtn.textContent = 'Cargando...'; loadImage(imageUrl);});

            async function loadImage(url) {
                // ... (El código de carga no tiene cambios)
                resetState();statusDiv.innerHTML='<p>Cargando y procesando archivo... Esto puede tardar.</p>';try{const response=await fetch(url);if(!response.ok)throw new Error(`No se pudo encontrar el archivo: ${url}. Asegúrate que esté en la misma carpeta.`);const arrayBuffer=await response.arrayBuffer();const tiff=await GeoTIFF.fromArrayBuffer(arrayBuffer);const image=await tiff.getImage();const fileDirectory=image.getFileDirectory();if(!fileDirectory.ModelPixelScale)throw new Error('El archivo no contiene metadatos de escala (ModelPixelScale).');realScale=fileDirectory.ModelPixelScale[0];const width=image.getWidth();const height=image.getHeight();offscreenCanvas.width=width;offscreenCanvas.height=height;const data=await image.readRasters({interleave:!0});const rgba=new Uint8ClampedArray(width*height*4);const samplesPerPixel=image.getSamplesPerPixel();for(let i=0;i<width*height;i++){if(samplesPerPixel===1){rgba[i*4]=data[i];rgba[i*4+1]=data[i];rgba[i*4+2]=data[i]}else{rgba[i*4]=data[i*samplesPerPixel];rgba[i*4+1]=data[i*samplesPerPixel+1];rgba[i*4+2]=data[i*samplesPerPixel+2]}rgba[i*4+3]=255}const imageData=new ImageData(rgba,width,height);offscreenCtx.putImageData(imageData,0,0);const scaleX=container.clientWidth/width;const scaleY=container.clientHeight/height;transform.scale=Math.min(scaleX,scaleY);transform.offsetX=(container.clientWidth-width*transform.scale)/2;transform.offsetY=(container.clientHeight-height*transform.scale)/2;redraw();statusDiv.innerHTML=`<p><b>Imagen cargada.</b></p><p>Resolución: <b>${realScale.toFixed(4)} m/píxel</b>.</p><p>Usa el botón para medir.</p>`;measureBtn.disabled=!1;loadGroup.style.display='none';measureGroup.style.display='block'}catch(err){console.error(err);statusDiv.innerHTML=`<p><b>Error:</b> ${err.message}</p>`;resetState();loadBtn.disabled=!1;loadBtn.textContent='Cargar Imagen'}
            }
            
            measureBtn.addEventListener('click',()=>{isMeasureModeActive=!isMeasureModeActive;if(isMeasureModeActive){measureBtn.textContent='Desactivar Medición';measureBtn.classList.add('active');canvas.classList.add('measuring-mode');statusDiv.innerHTML='<p><b>Modo de Medición Activado.</b></p><p>Haz clic en dos puntos para medir.</p>'}else{measureBtn.textContent='Activar Medición';measureBtn.classList.remove('active');canvas.classList.remove('measuring-mode');statusDiv.innerHTML='<p><b>Modo de Medición Desactivado.</b></p><p>Puedes mover el mapa y hacer zoom.</p>';if(measuring){measuring=!1;redraw()}}});
            
            canvas.addEventListener('mousedown',(e)=>{
                if(!realScale||e.button!==0)return;
                if(isMeasureModeActive){
                    const pos=getTransformedPoint(e.offsetX,e.offsetY);
                    if(!isPointOnImage(pos))return;
                    if(!measuring){
                        startPoint=pos;endPoint=pos;measuring=!0;
                        statusDiv.innerHTML='<p>Primer punto seleccionado. <br><b>Clic derecho para cancelar.</b></p>'
                    } else {
                        endPoint=pos;measuring=!1;
                        const pixelDistance=Math.sqrt(Math.pow(endPoint.x-startPoint.x,2)+Math.pow(endPoint.y-startPoint.y,2));
                        const realDistanceMeters=pixelDistance*realScale;
                        resultDiv.innerHTML=`<p><b>${realDistanceMeters.toFixed(2)}</b> metros</p>`;
                        
                        // CAMBIO: Mostrar el panel de resultados
                        resultGroup.style.display = 'block';

                        measureBtn.click();
                    }
                } else {
                    isPanning=!0;
                    canvas.classList.add('panning');
                    lastPanPosition={x:e.offsetX,y:e.offsetY};
                }
            });

            canvas.addEventListener('contextmenu',(e)=>{e.preventDefault();if(isMeasureModeActive){measureBtn.click()}});
            function redraw(){if(!offscreenCanvas.width)return;canvas.width=container.clientWidth;canvas.height=container.clientHeight;ctx.save();ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.setTransform(transform.scale,0,0,transform.scale,transform.offsetX,transform.offsetY);ctx.drawImage(offscreenCanvas,0,0);if(measuring&&startPoint&&endPoint){ctx.beginPath();ctx.moveTo(startPoint.x,startPoint.y);ctx.lineTo(endPoint.x,endPoint.y);ctx.strokeStyle='red';ctx.lineWidth=2/transform.scale;ctx.stroke()}ctx.restore()}
            function getTransformedPoint(x,y){return{x:(x-transform.offsetX)/transform.scale,y:(y-transform.offsetY)/transform.scale}}
            function isPointOnImage(point){if(!offscreenCanvas.width)return!1;return point.x>=0&&point.x<=offscreenCanvas.width&&point.y>=0&&point.y<=offscreenCanvas.height}
            function zoom(factor,centerX,centerY){if(!realScale)return;const pt=getTransformedPoint(centerX,centerY);transform.scale*=factor;transform.offsetX=centerX-pt.x*transform.scale;transform.offsetY=centerY-pt.y*transform.scale;redraw()}
            canvas.addEventListener('wheel',(e)=>{e.preventDefault();const factor=e.deltaY<0?1.1:1/1.1;zoom(factor,e.offsetX,e.offsetY)});
            canvas.addEventListener('mousemove',(e)=>{if(isPanning){transform.offsetX+=e.offsetX-lastPanPosition.x;transform.offsetY+=e.offsetY-lastPanPosition.y;lastPanPosition={x:e.offsetX,y:e.offsetY};redraw()}else if(measuring){endPoint=getTransformedPoint(e.offsetX,e.offsetY);redraw()}});
            canvas.addEventListener('mouseup',()=>{isPanning=!1;canvas.classList.remove('panning')});
            canvas.addEventListener('mouseleave',()=>{isPanning=!1;canvas.classList.remove('panning')});
            window.addEventListener('resize',redraw);
            function resetState(){realScale=null;startPoint=null;endPoint=null;measuring=!1;transform={scale:1,offsetX:0,offsetY:0};offscreenCanvas.width=0;offscreenCanvas.height=0;redraw()}
        });
    </script>
</body>
</html>